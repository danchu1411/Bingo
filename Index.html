<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back_ios" />
    <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    p {
      color: black;
    }

    h1 {
      text-align: center;
      font-size: 50px;
      margin: 20px 0;
    }

    .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            width: 300px;
            height: 300px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cell {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        text-transform: uppercase;
        border-radius: 4px;
    }

    .cell.free {
        background-color: #6c757d;
        color: #fff;
    }

    #bingo-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }

    #number-input-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    #number-input-container input {
      padding: 10px;
      font-size: 16px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #number-input-container button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    #number-input-container button:hover {
      background-color: #0056b3;
    }

    .option {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    .option.hide {
      display: none;
    }

    .option > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f8f9fa;
    }

    .btn-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }

    .btn-container > div > button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .btn-container > div > button:hover {
      background-color: #0056b3;
    }

    #board-input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #board-input-container.hide {
      display: none;
    }

    #board-input-container input {
      margin-bottom: 20px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      z-index: 10;
    }

    .loading-overlay.hide {
      display: none;
    }

    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
    }

    .link-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .link-container a {
      color: black;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .link-container button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .main-content.hide {
      display: none;
    } 

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @media screen and (max-width: 768px) {
      .bingo-card {
        max-width: 300px;
      }

      #number-input-container input {
        width: 200px;
      }
    }

    @media screen and (max-width: 480px) {
      .bingo-card {
        max-width: 100%;
      }
    }
</style>

    
</head>
<body>
    <h1>Bingo</h1>
    <span class="material-symbols-outlined">
        arrow_back_ios
    </span>
    <!-- <div class="option">
        <div>
            <h2>Which ways you want to import Bingo Board?</h2>
            <div class="btn-container">
                <div class="left">
                    <button id="importSheetBtn" onclick="onChooseSheet()">Import from sheet</button>
                </div>
                <div class="right">
                    <button id="importImageBtn" onclick="onChooseImage()">Import from image</button>
                </div>
            </div> 
        </div>
    </div> -->

    <div class="loading-overlay hide">
        <div class="spinner"></div>
    </div>

    <div class="link-container"></div>

    <div class="main-content">
      <div id="board-input-container">
        <div>
            <input type="file" accept="image/png, image/jpeg" id="file-input" placeholder="Image/png/jpeg" multiple/>
            <button id="submit_btn" onclick="onSubmit()">Submit</button>
        </div>
      </div>
      <div id="number-input-container">
        <input type="text" id="number" placeholder="Enter a number">
        <button id="draw_btn" onclick="draw()">Draw</button>
      </div>
      <div id="bingo-container"></div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.loading-overlay').classList.remove('hide');
            google.script.run.withSuccessHandler(onGetSheetUrl).getSheetUrl();
        });
        
        let recentTables = [];
        let boardData = [];
        let drawedSet = new Set();

        function onGetSheetUrl(url) {
          const linkText = document.createTextNode('Click here to import bingo board from sheet');
          const linkContainer = document.querySelector('.link-container');
          const link = document.createElement('a');
          const button = document.createElement('button');
          button.textContent = 'Import';
          button.onclick = () => {
              google.script.run.withFailureHandler(onImportSheetFailure).withSuccessHandler(onImportSheetSuccess).extractAllDataFromSheet();
              document.querySelector('.loading-overlay').classList.remove('hide');
          };
          
          link.href = url;
          link.target = '_blank';
          link.appendChild(linkText);
          linkContainer.appendChild(link);
          linkContainer.appendChild(button);
          document.querySelector('.loading-overlay').classList.add('hide');
        }

        /**
         * Import sheet failure
         */
        function onImportSheetFailure(err) {
            alert('Failed to import data from sheet' + err);
            document.querySelector('.loading-overlay').classList.add('hide');
        }

        /**
         * Get recent bingo boards
         * @param {Array} result 
         */
         function onImportSheetSuccess(result) {
            recentTables = result;
            recentTables.forEach((table) => {
                addBoardToScreen(table);
            });
            document.querySelector('.loading-overlay').classList.add('hide');
        }

        /**
         * Import image
         */
        function onChooseImage  () {
            document.querySelector('.option').classList.add('hide');
            document.querySelector('.main-content').classList.remove('hide');
            document.getElementById('board-input-container').classList.remove('hide');
            document.getElementById('number-input-container').classList.remove('hide');
        }

        /**
         * Convert array to 2D array
         * @param {Array} arr 
         * @returns {Array}
         */
        function convertToTwoDimensionalArray(arr) {
            let result = []; 
            for (let i = 0; i < 5; i++) { 
            result.push(arr.slice(i * 5, i * 5 + 5)); 
            } 
            return result;
        }

        /**
         * Add bingo board to screen
         * @param {Array} tableNumbers 
         */
        function addBoardToScreen(tableNumbers) {
            const bingoCard = document.createElement('div');
            bingoCard.classList.add('bingo-card');
            const bingoContainer = document.getElementById('bingo-container');

            // Initialize board data
            let positions = {};               
            let rowMarks = [0, 0, 0, 0, 0];    
            let colMarks = [0, 0, 0, 0, 0];   
            let diag1Marks = 0;               
            let diag2Marks = 0;              
            let hasBingo = false;             
            const size = 5; 

            // Create cells
            for(let i = 0; i < tableNumbers.length; i++) {
                for(let j = 0; j < tableNumbers[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');

                    let val = tableNumbers[i][j];
                    if (i === 2 && j === 2) { // Center cell
                        cell.classList.add('free');
                        cell.textContent = 'Free';
                        tableNumbers[i][j] = 'X';
                        val = 'X';

                        rowMarks[i]++;
                        colMarks[j]++;
                        if (i === j) {
                            diag1Marks++;
                        }
                        if (i + j === size - 1) {
                            diag2Marks++;
                        }
                    }
                    else { 
                      cell.textContent = val;
                    }
                    if (val !== 'X') {
                      positions[val] = { row: i, col: j };
                    }
                    bingoCard.appendChild(cell);
                }
            }

            boardData.push({
              positions,
              rowMarks,
              colMarks,
              diag1Marks,
              diag2Marks,
              hasBingo,
            });
            
            bingoContainer.appendChild(bingoCard);
        }

        /**
         * Draw number and check bingo for each board
         */
        function draw() {
            const number = document.getElementById('number').value.trim();
            
            if (number === '') {
              alert('Please enter a number');
              return;
            }
            if (recentTables.length === 0) {
              alert('Please import a bingo board first');
              return;
            }
            if (drawedSet.has(number)) {
              alert('Number already drawed');
              return;
            }

            let anyBoardBingo = false;

            boardData.forEach((table, tableIndex) => {
                if(table.hasBingo && !table.positions.hasOwnProperty(number)) {
                  return;
                }

                drawedSet.add(number);

                const { row, col } = table.positions[number];
                recentTables[tableIndex][row][col] = 'X';
                
                table.rowMarks[row]++;
                table.colMarks[col]++;
                if(row === col) {
                  table.diag1Marks++;
                }
                if(row + col === 4) {
                  table.diag2Marks++;
                }

                highlightCell(row, col, tableIndex);

                if(table.rowMarks[row] === 5 || table.colMarks[col] === 5 || table.diag1Marks === 5 || table.diag2Marks === 5) {
                  table.hasBingo = true;
                  anyBoardBingo = true;
                  highlightBingo(tableIndex, row, col, table);
                }
            });

            if (anyBoardBingo) {
              alert('Bingo!');
            }
        }


        /**
         * Highlight cell
         * @param {number} row 
         * @param {number} col 
         * @param {number} boardIndex 
         */
        function highlightCell(row, col, boardIndex) {
            const board = document.querySelectorAll('.bingo-card')[boardIndex];
            const cellIndex = row * 5 + col;
            const cell = board.querySelectorAll('.cell')[cellIndex];
            cell.style.backgroundColor = 'yellow';
        }


        /**
         * Highlight bingo
         * @param {number} boardIndex 
         * @param {number} row 
         * @param {number} col 
         * @param {Object} bData 
         */
        function highlightBingo(boardIndex, row, col, bData) {
            const board = document.querySelectorAll('.bingo-card')[boardIndex];
            // If row is complete
            if (bData.rowMarks[row] === 5) {
                for (let j = 0; j < 5; j++) {
                    board.querySelectorAll('.cell')[row * 5 + j].style.backgroundColor = 'green';
                }
            }
            // If col is complete
            if (bData.colMarks[col] === 5) {
                for (let i = 0; i < 5; i++) {
                    board.querySelectorAll('.cell')[i * 5 + col].style.backgroundColor = 'green';
                }
            }
            // If main diagonal is complete
            if (bData.diag1Marks === 5) {
                for (let i = 0; i < 5; i++) {
                    board.querySelectorAll('.cell')[i * 5 + i].style.backgroundColor = 'green';
                }
            }
            // If anti-diagonal is complete
            if (bData.diag2Marks === 5) {
                for (let i = 0; i < 5; i++) {
                    board.querySelectorAll('.cell')[i * 5 + (4 - i)].style.backgroundColor = 'green';
                }
            }
        }


        /**
         * Submit image
         */
        function onSubmit () {
            const isOveride = window.confirm('Are you sure you want to overide the image?');
            document.querySelector('.loading-overlay').classList.remove('hide');
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            const blobArr = [];

            if (files.length > 0) {
              Array.from(files).forEach(file => {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                  const base64String = e.target.result.split(',')[1];
                  const name = file.name;
                  const type = file.type;
                  blobArr.push({base64String, type});
                  }
                  reader.readAsDataURL(file);
              })
              setTimeout((() => {
                  google.script.run.withFailureHandler(onGenerateFailure).withSuccessHandler(onGenerateSuccess).sendToGeminiByBase64(blobArr, isOveride);
              }), 2000)
            } 
            else 
            {
                alert('Please select a file');
                document.querySelector('.loading-overlay').classList.add('hide'); 
            }
        }

        /**
         * Generate failure
         */
        function onGenerateFailure() {
            alert('Failed to submit image');
            document.querySelector('.loading-overlay').classList.add('hide');
        }

        /**
         * Generate success
         * @param {Array} result 
         */
        function onGenerateSuccess(result) {
          recentTables.push(result);
          result.forEach(board => {
              addBoardToScreen(board); 
          })
          document.querySelector('.loading-overlay').classList.add('hide'); 
        }
    </script>
</body>
</html>
