<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo</title>
    <base target="_top">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back_ios" />
    <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    p {
      color: black;
    }

    h1 {
      text-align: center;
      font-size: 50px;
      margin: 20px 0;
    }

    .bingo-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            width: 300px;
            height: 300px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cell {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        text-transform: uppercase;
        border-radius: 4px;
    }

    .cell.free {
        background-color: #6c757d;
        color: #fff;
    }

    #bingo-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
    }

    #number-input-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    #number-input-container input {
      padding: 10px;
      font-size: 16px;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #number-input-container button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    #number-input-container button:hover {
      background-color: #0056b3;
    }

    .option-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      flex-direction: column;
      z-index: 10;
    }

    .option-overlay.hide {
      display: none;
    }

    .option-overlay > div {
      width: 90%;
      max-width: 400px;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .btn-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }

    .btn-container > div > button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .btn-container > div > button:hover {
      background-color: #0056b3;
    }

    #board-input-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #board-input-container input {
      margin-bottom: 20px;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      z-index: 10;
    }

    .loading-overlay.hide {
      display: none;
    }

    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @media screen and (max-width: 768px) {
      .bingo-card {
        max-width: 300px;
      }

      #number-input-container input {
        width: 200px;
      }
    }

    @media screen and (max-width: 480px) {
      .bingo-card {
        max-width: 100%;
      }
    }
</style>

    
</head>
<body>
    <h1>Bingo</h1>
    <span class="material-symbols-outlined">
        arrow_back_ios
    </span>
    <div class="option-overlay">
        <div>
            <h2>Which ways you want to import Bingo Board?</h2>
            <div class="btn-container">
                <div class="left">
                    <button id="importSheetBtn" onclick="onImportSheet()">Import from sheet</button>
                </div>
                <div class="right">
                    <button id="importImageBtn" onclick="onImportImage()">Import from image</button>
                </div>
            </div> 
        </div>
    </div>

    <div class="loading-overlay hide">
        <div class="spinner"></div>
    </div>

    <div id="board-input-container" class="hide">
        <div>
            <input type="file" accept="image/png, image/jpeg" id="file-input" multiple/>
            <button id="submit_btn" onclick="onSubmit()">Submit</button>
        </div>
    </div>
    <div id="number-input-container">
        <input type="text" id="number" placeholder="Enter a number">
        <button id="draw_btn" onclick="draw()">Draw</button>
    </div>
    <div id="bingo-container"></div>

    <script>

        let recentTables = [];

        function onImportSheet () {
                google.script.run.withSuccessHandler(onSuccess).extractAllDataFromSheet();
                document.querySelector('.option-overlay').classList.add('hide');
                document.getElementsByClassName('loading-overlay')[0].classList.remove('hide');
                document.getElementById('board-input-container').classList.add('hide');
        }

        function onImportImage  () {
            document.querySelector('.option-overlay').classList.add('hide');
            document.getElementById('board-input-container').classList.remove('hide');
        }

        function convertToTwoDimensionalArray(arr) {
            let result = []; 
            for (let i = 0; i < 5; i++) { 
            result.push(arr.slice(i * 5, i * 5 + 5)); 
            } 
            return result;
        }

        let boardsArr = [];

        function onSuccess(result) {
            recentTables = result;
            recentTables.forEach((table) => {
                addBoardToScreen(table);
            });
            document.querySelector('.loading-overlay').classList.add('hide');
        }

        function addBoardToScreen(tableNumbers) {
            const bingoCard = document.createElement('div');
            bingoCard.classList.add('bingo-card');
            const bingoContainer = document.getElementById('bingo-container');

            for(let i = 0; i < tableNumbers.length; i++) {
                for(let j = 0; j < tableNumbers[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    if (i === 2 && j === 2) {
                        cell.classList.add('free');
                        cell.textContent = 'Free';
                    }
                    else {
                        cell.textContent = tableNumbers[i][j];
                    }
                    
                    bingoCard.appendChild(cell);
                }
            }
            bingoContainer.appendChild(bingoCard);
        }

        function draw () {
            const number = document.getElementById('number').value.trim();

            if (number === '') {
                alert('Please enter a number');
                return;
            }
            if (recentTables.length === 0) {
                alert('Please import a bingo board first');
                return;
            }

            recentTables.forEach((table, index) => {
                for (let i = 0; i < table.length; i++) {
                    for (let j = 0; j < table[i].length; j++) {
                        if (table[i][j] == number) {
                            table[i][j] = 'X';
                            highlightCell((i * 5 + j), index);
                            
                        } 
                    }
                }
            });
        };

        const highlightCell = (cellIndex, boardIndex) => {
            const board = document.querySelectorAll('.bingo-card')[boardIndex];
            board.querySelectorAll('.cell')[cellIndex].style.backgroundColor = 'yellow';
        }

        function checkBingo() {
            recentTables.forEach((table) => {
                const cells = document.querySelectorAll('.bingo-card .cell');
                let isBingo = false;
                let bingoRowIndex = -1;
                // Check row
                for (let i = 0; i < table.length; i++) {
                    if (table[i].every(cell => cell === 'X')) {
                        isBingo = true;
                        bingoRowIndex = i;
                        break;
                    } else
                    {
                        isBingo = false;
                    }
                }

                if (isBingo) {
                    alert('Bingo!');
                    for (let j = 0; j < table[bingoRowIndex].length; j++) {
                        const cellIndex = bingoRowIndex * 5 + j;
                        cells[cellIndex].style.backgroundColor = 'green';
                    }
                }


                // Check column
                for (let j = 0; j < table[0].length; j++) {
                    let isBingo = true;
                    for (let i = 0; i < table.length; i++) {
                        if (table[i][j] !== 'X') {
                            isBingo = false;
                            break;
                        }
                    }
                    if (isBingo) {
                        alert('Bingo!');
                        for (let i = 0; i < table.length; i++) {
                            const cellIndex = i * 5 + j;
                            cells[cellIndex].style.backgroundColor = 'green';
                        }
                    }
                }

                // Check diagonal
                if (table[0][0] === 'X' && table[1][1] === 'X' && table[2][2] === 'X' && table[3][3] === 'X' && table[4][4] === 'X') {
                    alert('Bingo!');
                    for (let i = 0; i < table.length; i++) {
                        const cellIndex = i * 5 + i;
                        cells[cellIndex].style.backgroundColor = 'green';
                    }
                }
            });
        }

        function onSubmit () {
            document.querySelector('.loading-overlay').classList.remove('hide');
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            const blobArr = [];

            if (files.length > 0) {
              Array.from(files).forEach(file => {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                  const base64String = e.target.result.split(',')[1];
                  const name = file.name;
                  const type = file.type;
                  blobArr.push({base64String, type});
                  }
                  reader.readAsDataURL(file);
              })
              setTimeout((() => {
                  google.script.run.withSuccessHandler(onGenerate).sendToGeminiByBase64(blobArr);
              }), 2000)
            } 
            else 
            {
                alert('Please select a file');
                document.querySelector('.loading-overlay').classList.add('hide'); 
            }
        }

        function onGenerate(result) {
            result.forEach(board => {
                addBoardToScreen(board); 
            })
            document.querySelector('.loading-overlay').classList.add('hide'); 
        }
    </script>
</body>
</html>
